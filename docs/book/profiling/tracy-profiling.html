<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Tracy profiling - MapLibre Native Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../diff.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">MapLibre Native Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="tracy-profiling"><a class="header" href="#tracy-profiling">Tracy profiling</a></h1>
<h4 id="introduction"><a class="header" href="#introduction">Introduction</a></h4>
<p>MapLibre Native integrates <a href="https://github.com/wolfpld/tracy">Tracy profiler</a> which offers an easy way to understand and optimize your application's CPU and GPU performance.
Tracy mainly consists in manually adding markup instrumentation in the code to log performance events. These events can then be analyzed and visualized using the <a href="https://github.com/wolfpld/tracy/tree/master/profiler">Tracy Profiler tool</a>.</p>
<p>Instrumentation is generally the first step in profiling applications that use MapLibre. Once slow inner-loop routines are identified, additional hardware vendor specific tools can be used to collect hardware counters and optimize low level CPU and GPU code.</p>
<h4 id="tracy-client"><a class="header" href="#tracy-client">Tracy client</a></h4>
<p>Tracy client consists of an API to mark CPU and GPU performance zones. A zone is a code section where the start and end timestamps are recorded.</p>
<h4 id="tracy-server"><a class="header" href="#tracy-server">Tracy server</a></h4>
<p>The server is the Tracy profiler that allows the analysis and visualization of the client recorded data.
The server can be downloaded from <a href="https://github.com/wolfpld/tracy/releases">Tracy release page</a> or it can be easily built from <a href="https://github.com/wolfpld/tracy/tree/master/profiler">sources</a> on Linux, Windows or Mac using CMake</p>
<h4 id="enabling-instrumentation-in-maplibre-native"><a class="header" href="#enabling-instrumentation-in-maplibre-native">Enabling instrumentation in MapLibre Native</a></h4>
<p>Instrumentation is enabled by turning <code>ON</code> the CMake option <code>MLN_USE_TRACY</code>.
Tracy computational overhead is very low but by default it keeps all instrumentation events that are not consumed by the server in system memory. This can have a negative effect on platforms with low memory. To prevent high memory usage, <code>TRACY_ON_DEMAND</code> macro should defined. This way instrumentation data is only stored when the server is connected to the application.</p>
<h4 id="instrumentation-in-maplibre"><a class="header" href="#instrumentation-in-maplibre">Instrumentation in MapLibre</a></h4>
<p>The file <code>include/mbgl/util/instrumentation.hpp</code> defines the following instrumentation macros:</p>
<h5 id="mln_trace_zonelabel"><a class="header" href="#mln_trace_zonelabel"><code>MLN_TRACE_ZONE(label)</code></a></h5>
<p>The macro records the timestamps at the start and end of the code scope. The parameter label is a user defined name for the zone. Example:</p>
<pre><code class="language-cpp">// code is not instrumented
{
  MLN_TRACE_ZONE(EmptyZone) // Records from here until the end of the scope
  // code here is instrumented
}
// other here not instrumented
</code></pre>
<h5 id="mln_trace_func"><a class="header" href="#mln_trace_func"><code>MLN_TRACE_FUNC()</code></a></h5>
<p>The macro is meant to be placed at the start of a function and expands to:</p>
<pre><code class="language-cpp">MLN_TRACE_ZONE(__FUNCTION__)
</code></pre>
<h5 id="gpu-instrumentation"><a class="header" href="#gpu-instrumentation">GPU instrumentation</a></h5>
<p>OpenGL is also supported in MapLibre native. Tracy support is currently missing for other APIs such as Metal and need to be added separately.</p>
<h5 id="mln_trace_gl_zonelabel"><a class="header" href="#mln_trace_gl_zonelabel"><code>MLN_TRACE_GL_ZONE(label)</code></a></h5>
<p>This macro is similar to <code>MLN_TRACE_ZONE</code> except that <a href="https://www.khronos.org/opengl/wiki/Query_Object">OpenGL timestamp queries</a> are inserted in the GPU command buffer instead of recording CPU time.</p>
<h5 id="mln_trace_func_gllabel"><a class="header" href="#mln_trace_func_gllabel"><code>MLN_TRACE_FUNC_GL(label)</code></a></h5>
<p>This macro is similar to <code>MLN_TRACE_FUNC</code> except that <a href="https://www.khronos.org/opengl/wiki/Query_Object">OpenGL timestamp queries</a> are inserted in the GPU command buffer instead of recording CPU time.</p>
<h5 id="other-macros"><a class="header" href="#other-macros">Other macros</a></h5>
<p>The above macros can be added inside MapLibre code and also in the application code that calls MapLibre.</p>
<p>The following macros should only be used if there are changes to MapLibre internals:</p>
<h5 id="mln_end_frame"><a class="header" href="#mln_end_frame"><code>MLN_END_FRAME()</code></a></h5>
<p>Mark the end of a frame.</p>
<h5 id="mln_trace_gl_context"><a class="header" href="#mln_trace_gl_context"><code>MLN_TRACE_GL_CONTEXT()</code></a></h5>
<p>Placed after an OpenGL context is created.</p>
<h5 id="mln_trace_alloc_textureid-size-and-mln_trace_free_textureid"><a class="header" href="#mln_trace_alloc_textureid-size-and-mln_trace_free_textureid"><code>MLN_TRACE_ALLOC_TEXTURE(id, size)</code> and <code>MLN_TRACE_FREE_TEXTURE(id)</code></a></h5>
<p>Record a read-only texture allocation and deallocation</p>
<h5 id="mln_trace_alloc_rtid-size-and-mln_trace_free_rtid"><a class="header" href="#mln_trace_alloc_rtid-size-and-mln_trace_free_rtid"><code>MLN_TRACE_ALLOC_RT(id, size)</code> and <code>MLN_TRACE_FREE_RT(id)</code></a></h5>
<p>Record a render target texture allocation and deallocation</p>
<h5 id="mln_trace_alloc_vertex_bufferid-size-and-mln_trace_free_vertex_bufferid"><a class="header" href="#mln_trace_alloc_vertex_bufferid-size-and-mln_trace_free_vertex_bufferid"><code>MLN_TRACE_ALLOC_VERTEX_BUFFER(id, size)</code> and <code>MLN_TRACE_FREE_VERTEX_BUFFER(id)</code></a></h5>
<p>Record a buffer allocation and deallocation that is intended to be used as a read-only vertex buffer</p>
<h5 id="mln_trace_alloc_index_bufferid-size-and-mln_trace_free_index_bufferid"><a class="header" href="#mln_trace_alloc_index_bufferid-size-and-mln_trace_free_index_bufferid"><code>MLN_TRACE_ALLOC_INDEX_BUFFER(id, size)</code> and <code>MLN_TRACE_FREE_INDEX_BUFFER(id)</code></a></h5>
<p>Record a buffer allocation and deallocation that is intended to be used as a read-only index buffer</p>
<h5 id="mln_trace_alloc_const_bufferid-size-and-mln_trace_free_const_bufferid"><a class="header" href="#mln_trace_alloc_const_bufferid-size-and-mln_trace_free_const_bufferid"><code>MLN_TRACE_ALLOC_CONST_BUFFER(id, size)</code> and <code>MLN_TRACE_FREE_CONST_BUFFER(id)</code></a></h5>
<p>Record a buffer allocation and deallocation that is intended to be used as a constant buffer</p>
<h4 id="usage-example-on-linux-and-windows"><a class="header" href="#usage-example-on-linux-and-windows">Usage example on Linux and Windows</a></h4>
<p>Download or build the Tracy profiler (server) and run it.</p>
<p>Make sure you generate the MapLibre project with the option <code>MLN_USE_TRACY</code> enabled.</p>
<p>As an example, the glfw sample is used.</p>
<p>With CMake, in MapLibre repository root do</p>
<pre><code class="language-bash"># generate project
cmake -B build -GNinja -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_BUILD_TYPE=RelWithDebInfo -DMLN_WITH_CLANG_TIDY=OFF -DMLN_WITH_COVERAGE=OFF -DMLN_DRAWABLE_RENDERER=ON -DCMAKE_BUILD_WITH_INSTALL_RPATH=ON -DMLN_USE_TRACY=ON
# build
cmake --build build --target mbgl-glfw -j 8
# run
./build/platform/glfw/mbgl-glfw --style https://raw.githubusercontent.com/maplibre/demotiles/gh-pages/style.json --benchmark
</code></pre>
<p>with Bazel</p>
<pre><code class="language-bash"># build and run
bazel run //platform/glfw:glfw_app -- --style https://raw.githubusercontent.com/maplibre/demotiles/gh-pages/style.json --benchmark
</code></pre>
<p>In the Tracy Profiler hit the connect button (or select the glfw application from the list of applications that are running Tracy Client). Profile then optimize the code.</p>
<h4 id="connecting-the-profiler-to-a-maplibre-android-application"><a class="header" href="#connecting-the-profiler-to-a-maplibre-android-application">Connecting the profiler to a MapLibre Android application</a></h4>
<p>The Android application communicates instrumentation data to the profiler (Tracy server) on the network using port 8086 by default. You can expose the port to the profiler using Android Debug Bridge by running the command:</p>
<pre><code class="language-bash">adb forward tcp:8086 tcp:8086
</code></pre>
<h4 id="more-information-and-advanced-usage-in-tracy"><a class="header" href="#more-information-and-advanced-usage-in-tracy">More information and advanced usage in Tracy</a></h4>
<ul>
<li><a href="https://github.com/wolfpld/tracy/">Tracy Github page</a></li>
<li><a href="https://github.com/wolfpld/tracy/releases/latest/download/tracy.pdf">Tracy user guide</a></li>
<li><a href="https://www.youtube.com/watch?v=fB5B46lbapc">Tracy demo on Youtube</a></li>
<li><a href="https://www.youtube.com/watch?v=ghXk3Bk5F2U&amp;t=37s">Tracy CppCon presentation on Youtube</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../profiling/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../profiling/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
